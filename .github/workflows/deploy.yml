# ðŸš€ CI/CD Pipeline - LucresIA Elevare
# Dispara deploy automÃ¡tico no Railway quando hÃ¡ push na main
# VersÃ£o: 2.0.0 - Integrado com scripts de automaÃ§Ã£o

name: Deploy to Railway

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

# Set default permissions for GITHUB_TOKEN
permissions:
  contents: read

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '10'

jobs:
  # ============================================
  # ðŸ§¹ CLEANUP & STANDARDIZATION
  # ============================================
  cleanup:
    name: ðŸ§¹ Cleanup Codebase
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ§¹ Run cleanup script
        run: |
          chmod +x scripts/*.sh
          ./scripts/clean_codebase.sh || true

  # ============================================
  # ðŸ” QUALITY & SECURITY AUDIT
  # ============================================
  quality:
    name: ðŸ” Quality & Security Audit
    runs-on: ubuntu-latest
    needs: cleanup
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ”Ž Type Check
        run: pnpm check
        continue-on-error: true

      - name: ðŸ”’ Security Audit
        run: pnpm audit --audit-level=high
        continue-on-error: true

      - name: ðŸŽ¨ Format Check
        run: pnpm format
        continue-on-error: true

  # ============================================
  # ðŸ—ï¸ BUILD & TEST
  # ============================================
  build:
    name: ðŸ—ï¸ Build & Test
    runs-on: ubuntu-latest
    needs: quality
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ” Run audit and build script
        run: |
          chmod +x scripts/*.sh
          ./scripts/audit_and_build.sh

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 7

      - name: ðŸ“Š Build Summary
        run: |
          echo "### ðŸ“¦ Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Build completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Artifacts uploaded: dist/" >> $GITHUB_STEP_SUMMARY
          if [ -d "dist" ]; then
            echo "ðŸ“Š Build size: $(du -sh dist | cut -f1)" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # ðŸš€ DEPLOY TO RAILWAY
  # ============================================
  deploy:
    name: ðŸš€ Deploy to Railway
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸš‚ Deploy to Railway
        uses: bervProject/railway-deploy@main
        with:
          railway_token: ${{ secrets.RAILWAY_TOKEN }}
          service: ${{ secrets.RAILWAY_SERVICE_ID }}

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "### ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployed to Railway successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ URL: https://acceptable-elegance-production-0f9f.up.railway.app" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Deployed at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”– Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # ðŸ—„ï¸ DATABASE MIGRATION (Optional - Manual Trigger)
  # ============================================
  database:
    name: ðŸ—„ï¸ Database Migration
    runs-on: ubuntu-latest
    needs: deploy
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && github.event.head_commit && contains(github.event.head_commit.message, '[db]')
    permissions:
      contents: read
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: ðŸ“š Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ðŸ—„ï¸ Run database migration
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
        run: |
          chmod +x scripts/*.sh
          ./scripts/db_push.sh
        continue-on-error: false

      - name: ðŸ“Š Migration Summary
        run: |
          echo "### ðŸ—„ï¸ Database Migration Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Database schema updated successfully" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“… Migrated at: $(date)" >> $GITHUB_STEP_SUMMARY


  # ============================================
  # ðŸ“Š FINAL SUMMARY
  # ============================================
  notify:
    name: ðŸ“Š Final Summary
    runs-on: ubuntu-latest
    needs: [deploy]
    if: always()
    permissions:
      contents: read
    steps:
      - name: âœ… Success Notification
        if: success()
        run: |
          echo "ðŸŽ‰ Deploy concluÃ­do com sucesso!"
          echo "ðŸŒ URL: https://acceptable-elegance-production-0f9f.up.railway.app"
          echo "ðŸ“… Data: $(date)"
          echo ""
          echo "### âœ… Pipeline Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ All stages completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cleanup" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Quality & Security Audit" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Build & Test" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Deployment" >> $GITHUB_STEP_SUMMARY

      - name: âŒ Failure Notification
        if: failure()
        run: |
          echo "âŒ Pipeline failed. Check logs above for details."
          echo ""
          echo "### âŒ Pipeline Failed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please check the workflow logs for details." >> $GITHUB_STEP_SUMMARY

